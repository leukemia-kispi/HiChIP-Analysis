# ==============================================================
# Dockerfile: Ubuntu 18.04 + Miniconda + Legacy ChIP-seq Envs
# ==============================================================

FROM ubuntu:18.04
LABEL maintainer="Valdemar Priebe <valdemarpriebe@gmail.com>"
ENV DEBIAN_FRONTEND=noninteractive

# --------------------------------------------------------------
# System packages
# --------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    wget \
    bzip2 \
    curl \
    ca-certificates \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------
# Install Miniconda (Python 3.7)
# --------------------------------------------------------------
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-py37_4.9.2-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh
ENV PATH=/opt/conda/bin:$PATH

# --------------------------------------------------------------
# Copy YAML environment files into image
# --------------------------------------------------------------
COPY MACS2_legacy.yml /envs/MACS2_legacy.yml
COPY IDR_legacy.yml /envs/IDR_legacy.yml
COPY DovetailHiChIP_Legacy.yml /envs/DovetailHiChIP_Legacy.yml
COPY IDR_Legacy.yml /envs/IDR_Legacy.yml
COPY coolbox_Legacy.yml /envs/coolbox_Legacy.yml
COPY Picard_Legacy.yml /envs/Picard_Legacy.yml
COPY trimgalore_Legacy.yml /envs/trimgalore_Legacy.yml

# --------------------------------------------------------------
# Install Java (needed for Picard)
# --------------------------------------------------------------
RUN apt-get update && apt-get install -y openjdk-8-jre-headless && rm -rf /var/lib/apt/lists/*
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

# --------------------------------------------------------------
# Create conda environments
# --------------------------------------------------------------
RUN conda env create -f /envs/MACS2_legacy.yml && \
    conda env create -f /envs/IDR_legacy.yml && \
    conda env create -f /envs/DovetailHiChIP_Legacy.yml && \
    conda env create -f /envs/IDR_Legacy.yml && \
    conda env create -f /envs/coolbox_Legacy.yml && \
    conda env create -f /envs/Picard_Legacy.yml && \
    conda env create -f /envs/trimgalore_Legacy.yml && \
    conda clean -afy

# --------------------------------------------------------------
# Initialize Conda for bash shell
# --------------------------------------------------------------
RUN conda init bash
RUN echo "conda activate base" >> ~/.bashrc

# --------------------------------------------------------------
# Set bash as the default shell
# --------------------------------------------------------------
SHELL ["/bin/bash", "-c"]
CMD ["/bin/bash"]