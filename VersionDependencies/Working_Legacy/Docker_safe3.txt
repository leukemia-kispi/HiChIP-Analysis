# --------------------------------------------------------------------------------------------------------
# Ubuntu 18.04 + Miniconda + Legacy Bioinformatics Environments for HiChIP TCF3::HLF Analysis
# --------------------------------------------------------------------------------------------------------
FROM ubuntu:18.04
LABEL maintainer="Valdemar Priebe <valdemarpriebe@gmail.com>"

ENV DEBIAN_FRONTEND=noninteractive

# --------------------------------------------------------------
# System dependencies
# --------------------------------------------------------------

RUN apt-get update && apt-get install -y \
    wget \
    bzip2 \
    curl \
    ca-certificates \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------
# Install Miniconda (Python 3.7)
# --------------------------------------------------------------

RUN wget https://repo.anaconda.com/miniconda/Miniconda3-py37_4.9.2-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh
ENV PATH=/opt/conda/bin:$PATH

# --------------------------------------------------------------
# Copy legacy YAMLs
# --------------------------------------------------------------

COPY IDR_Legacy.yml /envs/IDR_Legacy.yml
COPY DovetailHiChIP_Legacy.yml /envs/DovetailHiChIP_Legacy.yml
COPY coolbox_Legacy.yml /envs/coolbox_Legacy.yml
COPY trimgalore_Legacy.yml /envs/trimgalore_Legacy.yml

# --------------------------------------------------------------
# Create environments one by one
# --------------------------------------------------------------

# IDR_Legacy environment
RUN conda env create -f /envs/IDR_Legacy.yml && conda clean -afy

# DovetailHiChIP_Legacy environment
RUN conda env create -f /envs/DovetailHiChIP_Legacy.yml && conda clean -afy

# coolbox_Legacy environment
RUN conda env create -f /envs/coolbox_Legacy.yml && conda clean -afy

# trimgalore_Legacy environment
RUN conda env create -f /envs/trimgalore_Legacy.yml && conda clean -afy

# --------------------------------------------------------------
# Install Java (needed for Picard)
# --------------------------------------------------------------
RUN apt-get update && apt-get install -y openjdk-8-jre-headless && rm -rf /var/lib/apt/lists/*
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

# --------------------------------------------------------------
# Create Picard environment manually
# --------------------------------------------------------------
RUN conda create -y -n Picard -c bioconda picard=2.25.7 && conda clean -afy


# --------------------------------------------------------------
# Create MACS2 environment manually with pinned dependencies
# --------------------------------------------------------------
RUN conda create -y -n MACS2 -c bioconda \
    macs2=2.2.6 \
    bowtie2=2.3.5.1 \
    samtools=1.7 \
    bedtools=2.30.0 \
    && conda clean -afy

# --------------------------------------------------------------
# Initialize Conda for bash shell
# --------------------------------------------------------------
RUN conda init bash
RUN echo "conda activate base" >> ~/.bashrc

# --------------------------------------------------------------
# Set bash as default shell
# --------------------------------------------------------------
SHELL ["/bin/bash", "-c"]
CMD ["/bin/bash"]

